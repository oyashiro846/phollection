# 50. セッション管理（中断・再開）

Claude Code の max-turns や token 制限に対応するため、作業の中断と再開を適切に行う。

## 中断の判断基準

以下の状況で作業を中断する:
- 残り turns が少なくなったと感じたとき（目安: 残り10turns以下）
  - タスクの複雑さによって実際の閾値は変動する
  - セットアップ・環境確認が必要な場合は早めに中断
  - 深い調査が予想される場合は余裕を持って判断
- 大きなタスクの区切りが来たとき
- エラーが続いて解決の目処が立たないとき

## 中断時にやること

### 1. 作業ログを残す
Issue/PR コメントに以下を記録:
- **完了した作業**: 何を終えたか
- **未完了の作業**: 何が残っているか
- **現在の状態**: どこで止まっているか（ファイル名、行番号等）
- **次にやるべきこと**: 再開時の最初のアクション
- **仮定・判断**: 実装中に行った仮定や判断

**推奨**: 作業開始時にコメントログテンプレート（後述）をコメントに記載し、進捗に応じて随時更新する。これにより再開時のコンテキスト再読み込みを最小化できる。

### 2. 差分をブランチに保存
```bash
# ステージング
git add -A

# 中断コミット（WIPであることを明示）
git commit -m "WIP: [作業内容の要約]

中断理由: [max-turns/token制限/エラー等]
残りタスク:
- [ ] タスク1
- [ ] タスク2

Co-Authored-By: Claude <noreply@anthropic.com>"

# プッシュ
git push origin <current-branch>
```

**WIPコミットの扱い**:
- 作業再開後、WIPコミットは以下のいずれかで処理:
  - **そのまま残す**: 作業履歴として価値がある場合（デバッグ過程の記録等）
  - **squash**: 最終的なPRをクリーンにしたい場合（`git rebase -i` で統合）
- `git log --oneline` でWIPコミットを素早く識別できる

### 3. ブランチ命名規則

継続作業用のブランチ命名:
- 形式: `claude/<issue-type>-<issue-number>-<YYYYMMDD>-<HHMM>`
- 例: `claude/issue-42-20250129-1530`
- 例: `claude/pr-123-20250129-1530`

中断時の追加ブランチが必要な場合:
- 形式: `claude/wip/<issue-number>-<連番>`
- 例: `claude/wip/42-1`, `claude/wip/42-2`

## 再開時にやること

### 1. 過去のコンテキストを確認
- Issue/PR のコメントで前回の作業ログを確認
- 特に「次にやるべきこと」を最優先で確認

### 2. ブランチの状態を確認
```bash
# ベースブランチの更新確認
git fetch origin
git log HEAD..origin/master --oneline  # ベースブランチに新しいコミットがあるか確認

# 差分確認
git log --oneline -5
git diff HEAD~1

# WIPコミットがあれば内容を確認
git show HEAD
```

**ベースブランチが更新されている場合**:
- リベース推奨: `git rebase origin/master`（コンフリクトに注意）
- マージも可: `git merge origin/master`（履歴が複雑になる）

### 3. Token節約のための工夫
- 前回のコメントログを参照し、同じ調査を繰り返さない
- 既にわかっている情報は再調査しない
- 前回の判断・仮定をそのまま引き継ぐ（変更が必要な場合のみ再検討）

## コメントログのフォーマット

中断時のコメントは以下の形式で記録:

```markdown
### 🔄 作業を中断します

#### 完了した作業
- [x] タスク1の説明
- [x] タスク2の説明

#### 未完了の作業
- [ ] タスク3の説明
- [ ] タスク4の説明

#### 現在の状態
- ファイル: `src/example.ts:42`
- 状態: [具体的な状態]

#### 次にやるべきこと
1. [最初のアクション]
2. [次のアクション]

#### 仮定・判断
- [実装中に行った仮定]
- [判断とその理由]

---
ブランチ: `claude/issue-XX-YYYYMMDD-HHMM`
コミット: `abc1234`
```

## 注意事項

- 中断は「失敗」ではない。計画的な中断はtoken効率を上げる（再調査を避けることで30-50%のtoken節約が可能）
- 再開時は必ず前回のログを読んでから作業を開始する
- 複数回の中断・再開が予想される大きなタスクは、最初から分割を検討する

## トラブルシューティング

### マージコンフリクトが発生した場合
```bash
# リベース中のコンフリクト
git status  # コンフリクトファイルを確認
# ファイルを手動修正後
git add <resolved-files>
git rebase --continue
```

### 依存関係が変更されていた場合
```bash
# package.json等が更新されている場合
npm install  # or yarn install, pip install -r requirements.txt 等
# テストを実行して互換性を確認
npm test
```

### WIPコミットを誤って作成した場合
```bash
# 直前のコミットを取り消し（変更は保持）
git reset --soft HEAD~1
# 改めて適切なコミットメッセージで作成
git commit -m "適切なメッセージ"
```

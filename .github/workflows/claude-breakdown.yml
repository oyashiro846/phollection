name: Claude Breakdown
run-name: "claude-breakdown issue #${{ github.event.issue.number }}"

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  actions: read
  id-token: write

concurrency:
  group: >-
    claude-breakdown-${{ github.event.issue.number }}
    -${{ github.event.comment.user.type == 'Bot' && 'bot' || 'user' }}
  cancel-in-progress: true

jobs:
  breakdown:
    if: |
      github.event.comment.user.type != 'Bot' &&
      contains(github.event.comment.body, '@claude') &&
      contains(github.event.comment.body, '[breakdown]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository to access local actions
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare context
        id: prep
        uses: Javakky/claude-starter/.github/actions/prepare-claude-context@master
        with:
          mode: "breakdown"
          impl_workflow_id: claude.yml # implement ワークフローのファイル名に合わせる
          allowed_comment_permissions: "admin,maintain,write"
          max_workflow_runs_to_scan: "50"

      - name: Debug prepare outputs
        run: |
          echo "should_run=${{ steps.prep.outputs.should_run }}"
          echo "reason=${{ steps.prep.outputs.reason }}"
          echo "trigger_kind=${{ steps.prep.outputs.trigger_kind }}"
          echo "issue_number=${{ steps.prep.outputs.issue_number }}"
          echo "issue_url=${{ steps.prep.outputs.issue_url }}"
          echo "milestone_number=${{ steps.prep.outputs.milestone_number }}"
          echo "milestone_title=${{ steps.prep.outputs.milestone_title }}"

      - name: Run Claude (breakdown)
        if: steps.prep.outputs.should_run == 'true'
        uses: Javakky/claude-starter/.github/actions/run-claude-breakdown@master
        with:
          comment_body: ${{ steps.prep.outputs.comment_body }}
          issue_number: ${{ steps.prep.outputs.issue_number }}
          milestone_number: ${{ steps.prep.outputs.milestone_number }}
          milestone_title: ${{ steps.prep.outputs.milestone_title }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # default_model: 'opus'
          # default_max_turns: 100


name: Claude Implement
run-name: "claude-impl issue #${{ github.event.issue.number }}"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: >-
    claude-impl-${{ github.event.issue.number }}
    -${{ contains(github.event.comment.body, '[review]') && 'review' || 'implement' }}
    -${{ github.event.comment.user.type == 'Bot' && 'bot' || 'user' }}
  cancel-in-progress: true

jobs:
  impl:
    if: |
      github.event.comment.user.type != 'Bot' &&
      contains(github.event.comment.body, '@claude') &&
      !contains(github.event.comment.body, '[review]')
    runs-on: ubuntu-latest
    steps:
      # ローカル action を読むために checkout は必要
      # ここではデフォルトブランチを取る（issue起点 implement は Claude 側がブランチ作成する想定）
      - name: Checkout repository to access local actions
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare context
        id: prep
        uses: Javakky/claude-starter/.github/actions/prepare-claude-context@master
        with:
          mode: "implement"
          impl_workflow_id: claude.yml # ←この workflow ファイル名に合わせる（ファイル名変えるならここも変える）

      # PR上の@claude(implement)であれば、そのPRの review を止めたい（任意）
      - name: Cancel running reviews for this PR
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: Javakky/claude-starter/.github/actions/cancel-claude-runs@master
        with:
          workflow_id: claude-review.yml
          pr_number: ${{ steps.prep.outputs.pr_number }}
          head_ref: ${{ steps.prep.outputs.head_ref }}
          head_sha: ${{ steps.prep.outputs.head_sha }}

      # PR conversation から呼ばれた場合だけ、そのブランチへ checkout し直す
      - name: Checkout PR head branch (PR conversation only)
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prep.outputs.head_ref }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer
          coverage: none

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist --no-interaction

      - name: Run Claude (implement)
        if: steps.prep.outputs.should_run == 'true'
        uses: Javakky/claude-starter/.github/actions/run-claude@master
        with:
          # Issue起点でもPR起点でも、@claude を含む本文がそのままClaudeに渡る
          comment_body: ${{ steps.prep.outputs.comment_body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # default_model: 'opus'
          # default_max_turns: 20
          allowed_tools: |
            Bash(vendor/bin/php-cs-fixer fix)
            Bash(vendor/bin/phpstan analyse -c phpstan.neon)
            Bash(vendor/bin/phpunit tests)
